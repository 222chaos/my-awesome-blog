# My Awesome Blog - 数据库初始化指南

## 概述

本指南介绍如何使用提供的数据库初始化脚本来设置和初始化数据库。

## 初始化脚本说明

### 1. init_db_simple.py
- **功能**: 简单的数据库初始化
- **操作**:
  - 创建所有数据库表结构
  - 初始化基础数据
  - 创建管理员用户
- **使用场景**: 首次部署或重新初始化数据库

### 2. init_db_basic.py
- **功能**: 基础数据库初始化
- **操作**:
  - 仅创建数据库表结构
  - 创建管理员用户
- **使用场景**: 快速初始化，不包含示例数据

### 3. full_init.py
- **功能**: 完整的数据库初始化流程
- **操作**:
  - 运行数据库迁移
  - 创建表结构
  - 初始化所有数据
- **使用场景**: 完整部署流程

### 4. init_db.bat
- **功能**: Windows批处理脚本
- **操作**:
  - 自动激活虚拟环境
  - 运行数据库初始化
  - 显示完成信息
- **使用场景**: Windows环境下的便捷初始化

## 使用方法

### 方法一：使用批处理脚本（推荐 - Windows）

```bash
# 在项目根目录运行
init_db.bat
```

### 方法二：直接运行Python脚本

```bash
# 运行简单初始化
python scripts/init_db_simple.py

# 运行基础初始化
python scripts/init_db_basic.py

# 运行完整初始化
python scripts/full_init.py
```

### 方法三：使用Alembic迁移

```bash
# 运行所有迁移
alembic upgrade head
```

## 初始化后的重要信息

### 管理员账户
- **用户名**: `admin`
- **密码**: `admin123`
- **权限**: 超级用户权限

> **重要**: 在生产环境中，请立即修改默认密码！

### 数据库表结构
初始化后将创建以下主要表：
- `users`: 用户表
- `articles`: 文章表
- `comments`: 评论表
- `categories`: 分类表
- `tags`: 标签表
- `friend_links`: 友情链接表
- `portfolios`: 作品集表
- `timeline_events`: 时间线事件表
- `subscriptions`: 订阅表
- `images`: 图像表
- `typewriter_contents`: 打字机内容表
- `request_logs`: 请求日志表

## 故障排除

### 常见问题及解决方案

#### 1. 数据库连接失败
- **症状**: 连接数据库时出错
- **解决方案**:
  - 检查数据库服务是否运行
  - 验证数据库连接字符串是否正确
  - 确认数据库用户权限

#### 2. 表已存在错误
- **症状**: 报错"relation already exists"
- **解决方案**: 
  - 这通常是正常现象，表示表已存在
  - 如需重新初始化，请先清空数据库

#### 3. 密码长度错误
- **症状**: bcrypt报错密码超过72字节
- **解决方案**:
  - 脚本会自动处理此问题
  - 确保密码不超过72字节

#### 4. 权限不足
- **症状**: 无法创建表或插入数据
- **解决方案**:
  - 确认数据库用户有足够权限
  - 检查数据库配置

## 生产环境部署注意事项

1. **安全性**:
   - 修改默认管理员密码
   - 使用强密码
   - 配置SSL连接

2. **性能**:
   - 调整数据库连接池大小
   - 配置适当的缓存策略
   - 设置数据库索引

3. **备份**:
   - 定期备份数据库
   - 测试备份恢复流程
   - 设置自动备份任务

## 自定义配置

如需自定义初始化行为，可以修改以下配置：

- `app/core/config.py`: 应用配置
- `.env`: 环境变量
- `scripts/init_db_simple.py`: 初始化脚本

## API端点验证

初始化完成后，可以通过以下端点验证数据库状态：

- `GET /health`: 健康检查
- `GET /api/v1/users/`: 获取用户列表
- `GET /api/v1/articles/`: 获取文章列表

## 维护脚本

项目还包含以下维护脚本：

- `scripts/diagnose_db.py`: 数据库诊断
- `scripts/fix_db_connection.py`: 修复数据库连接
- `scripts/run_migrations.py`: 运行数据库迁移
- `scripts/update_db_config.py`: 更新数据库配置