# 登录页面卡顿问题修复方案

## 问题分析

经过仔细检查，发现登录后页面卡在原页面的根本原因：

### 核心问题：认证令牌存储不一致

1. **登录 API (`lib/api/auth.ts`)**:
   - `loginApi()` 只将 token 存储到 `localStorage`
   - **没有设置 cookie**

2. **中间件 (`middleware.ts`)**:
   - 检查 `request.cookies.get('auth_token')` 或 `request.headers.get('Authorization')`
   - **不会检查 `localStorage`**（因为中间件运行在服务端，无法访问客户端存储）

3. **结果**:
   - 登录后，token 存储在 `localStorage`
   - 用户访问受保护页面时，中间件检查 cookie，找不到 token
   - **中间件重定向回登录页面，形成死循环**

## 修复方案

### 方案 A：同时设置 Cookie 和 LocalStorage（推荐）

**优点**:
- 中间件能正确检查认证状态
- 客户端能快速访问 token
- 符合 Next.js 最佳实践

**实施步骤**:

1. **修改 `lib/api/auth.ts`**:
   - 添加 `setCookieToken()` 函数
   - `loginApi()` 成功后同时设置 cookie 和 localStorage

2. **修改 `middleware.ts`**:
   - 确保 cookie 名称一致为 `auth_token`
   - 优化路径匹配逻辑

3. **修改 `login/page.tsx`**:
   - 移除 `setTimeout` 延迟跳转
   - 使用 `window.location.href` 强制硬跳转，确保页面刷新

4. **添加登录后跳转检查**:
   - 在目标页面检查 localStorage 中的 token
   - 如果存在，正常渲染；如果不存在，重定向回登录页

### 方案 B：完全使用 Cookie（更安全但需更多改动）

将所有认证逻辑改为基于 cookie，完全移除 localStorage 依赖。

---

**推荐实施方案 A**，因为它改动最小，兼容现有架构，且保留了客户端快速访问能力。